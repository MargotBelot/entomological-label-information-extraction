# Multi-Label Docker Compose Pipeline
# 
# This file defines a complete multi-stage Docker Compose setup for processing entomological 
# label information extraction from full specimen images. It includes:
#
# 1. Detection: Detect and crop labels from specimen images
# 2. Empty/Not-Empty Classification: Filter out empty labels
# 3. Identifier/Description Classification: Separate identifier vs descriptive labels
# 4. Handwritten/Printed Classification: Classify text type
# 5. OCR Processing: Extract text using Tesseract
# 6. Post-processing: Clean and process extracted text
# 7. Consolidation: Link all results into comprehensive JSON output
#
# The pipeline processes images in ./data/MLI/input and outputs results to ./data/MLI/output
# Final consolidated results are available in ./data/MLI/output/consolidated_results.json

services:
  detection:
    stdin_open: true
    tty: true
    build:
      context: ..
      dockerfile: pipelines/segmentation.dockerfile
    shm_size: 2g
    volumes:
      - ${PWD}/data:/app/data
    command: python3 scripts/processing/detection.py -j data/MLI/input -o data/MLI/output
    environment:
      - PYTHONPATH=/app
    healthcheck:
      test: ["CMD-SHELL", "ls data/MLI/output/input_predictions.csv || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  empty_not_empty_classifier:
    stdin_open: true
    tty: true
    build:
      context: ..
      dockerfile: pipelines/empty_labels.dockerfile
    volumes:
      - ${PWD}/data:/app/data
    command: python3 scripts/processing/analysis.py -o data/MLI/output -i data/MLI/output/input_cropped
    environment:
      - PYTHONPATH=/app
    depends_on:
      detection:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "ls data/MLI/output/not_empty || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  nuri_notnuri_classifier:
    stdin_open: true
    tty: true
    build: 
      context: ..
      dockerfile: pipelines/classification.dockerfile
    volumes:
      - ${PWD}/data:/app/data
    command: python3 scripts/processing/classifiers.py -m 1 -j data/MLI/output/not_empty -o data/MLI/output
    environment:
      - PYTHONPATH=/app
    depends_on:
      empty_not_empty_classifier:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "ls data/MLI/output/not_identifier || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  handwritten_printed_classifier:
    stdin_open: true
    tty: true
    build: 
      context: ..
      dockerfile: pipelines/classification.dockerfile
    volumes:
      - ${PWD}/data:/app/data
    command: python3 scripts/processing/classifiers.py -m 2 -j data/MLI/output/not_identifier -o data/MLI/output
    environment:
      - PYTHONPATH=/app
    depends_on:
      nuri_notnuri_classifier:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "ls data/MLI/output/printed || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  tesseract:
    stdin_open: true
    tty: true
    build: 
      context: ..
      dockerfile: pipelines/tesseract.dockerfile
    volumes:
      - ${PWD}/data:/app/data
    command: python3 scripts/processing/tesseract.py -d data/MLI/output/printed -o data/MLI/output
    environment:
      - PYTHONPATH=/app
    depends_on:
      handwritten_printed_classifier:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "ls data/MLI/output/ocr_preprocessed.json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  postprocessing:
    stdin_open: true
    tty: true
    build: 
      context: ..
      dockerfile: pipelines/postprocessing.dockerfile
    volumes:
      - ${PWD}/data:/app/data
    command: >
      bash -c "
        echo 'Starting post-processing pipeline...' &&
        python3 scripts/postprocessing/process.py -j data/MLI/output/ocr_preprocessed.json -o data/MLI/output &&
        echo 'Consolidating all pipeline results...' &&
        python3 scripts/postprocessing/consolidate_results.py -o data/MLI/output -f consolidated_results.json &&
        echo 'SUCCESS: Multi-label pipeline completed successfully!' &&
        echo 'Results available in: data/MLI/output/' &&
        echo 'Consolidated results: data/MLI/output/consolidated_results.json'
      "
    environment:
      - PYTHONPATH=/app
    depends_on:
      tesseract:
        condition: service_completed_successfully
